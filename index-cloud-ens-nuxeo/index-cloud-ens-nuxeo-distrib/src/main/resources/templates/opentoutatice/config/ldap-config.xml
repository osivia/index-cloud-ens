<?xml version="1.0"?>

<component name="org.osivia.ldap.storage.users">

	<require>org.nuxeo.ecm.directory.ldap.LDAPDirectoryFactory</require>

	<extension
		target="org.nuxeo.ecm.directory.ldap.LDAPDirectoryFactory"
		point="servers">
		<server name="default">
			<ldapUrl>${nuxeo.ldap.url}</ldapUrl>
			<bindDn>${nuxeo.ldap.binddn}</bindDn>
			<bindPassword>${nuxeo.ldap.bindpassword}</bindPassword>
		</server>
	</extension>



	<extension
		target="org.nuxeo.ecm.directory.ldap.LDAPDirectoryFactory"
		point="directories">
		<directory name="ldapUserDirectory">
			<server>default</server>

			<rdnAttribute>uid</rdnAttribute>

			<schema>user</schema>
			<idField>username</idField>
			<passwordField>password</passwordField>
			<fieldMapping name="username">uid</fieldMapping>
			<fieldMapping name="password">userPassword</fieldMapping>
			<fieldMapping name="firstName">givenName</fieldMapping>
			<fieldMapping name="lastName">sn</fieldMapping>
			<fieldMapping name="email">mail</fieldMapping>
			<searchFilter>(&amp;((objectClass=inetOrgPerson)))</searchFilter>

			<searchBaseDn>${nuxeo.ldap.user.searchBaseDn}</searchBaseDn>
			<searchClass>inetOrgPerson</searchClass>
			<searchScope>onelevel</searchScope>
			<substringMatchType>subany</substringMatchType>

			<readOnly>true</readOnly>

			<cacheTimeout>3600</cacheTimeout>
			<cacheMaxSize>20000</cacheMaxSize>
			<querySizeLimit>500</querySizeLimit>
			<queryTimeLimit>60000</queryTimeLimit>

			<references>

				<ldapReference field="groups"
					directory="ldapGroupDirectory" forceDnConsistencyCheck="false"
					staticAttributeId="portalPersonProfile" />
			</references>


		</directory>

		<directory name="ldapGroupDirectory">
			<server>default</server>

			<rdnAttribute>cn</rdnAttribute>


			<schema>group</schema>
			<idField>groupname</idField>
			<fieldMapping name="groupname">cn</fieldMapping>
			<fieldMapping name="description">description</fieldMapping>
			<fieldMapping name="members">uniqueMember</fieldMapping>
			<fieldMapping name="subGroups">subGroups</fieldMapping>

			<searchBaseDn>${nuxeo.ldap.group.searchBaseDn}</searchBaseDn>
			<searchClass>groupOfUniqueNames</searchClass>
			<searchScope>subtree</searchScope>
			<substringMatchType>subany</substringMatchType>
			<cacheTimeout>3600</cacheTimeout>
			<cacheMaxSize>2000</cacheMaxSize>
			<querySizeLimit>500</querySizeLimit>
			<queryTimeLimit>60000</queryTimeLimit>

			<readOnly>true</readOnly>

			<references>

				<ldapReference field="members"
					directory="ldapUserDirectory" forceDnConsistencyCheck="false"
					staticAttributeId="uniqueMember" />

				<ldapReference field="subGroups"
					directory="ldapGroupDirectory" forceDnConsistencyCheck="false"
					staticAttributeId="subGroups" />
				<ldapReference field="parentGroups"
					directory="ldapGroupDirectory" forceDnConsistencyCheck="false"
					staticAttributeId="parentGroups" />
			</references>

		</directory>

	</extension>
</component>
